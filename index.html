<script>
// Questions
const categoriesData = {
  'Alimentation': [
    "Combien de fois utilisez-vous de l'huile d'olive ?",
    "Combien de fois utilisez-vous de l'huile de Colza, Lin, Noix par semaine ?",
    "Combien de fois par semaine consommez-vous du lait de vache ?",
    "Combien de fois par semaine consommez-vous du pain blanc (baguette, pain de mie) ?",
    "Combien de fois par semaine mangez-vous des féculents (pâtes, riz, pomme de terre,...) ?",
    "Combien de fois par semaine mangez-vous des crudites ou des fruits ?",
    "Combien de fois par semaine mangez-vous des légumes cuits ?",
    "Combien de fois par semaine mangez-vous des oléagineux (noisettes, amandes, noix de cajou, etc.) ?",
    "Combien de fois mangez-vous de la viande rouge ou porcine par semaine ?",
    "Combien de fois mangez-vous de la volaille par semaine (poulet, dinde,...) ?",
    "Combien de fois mangez-vous du poisson par semaine ?",
    "Est-ce que vous consommez des poissons gras (maquereau, sardines, saumon) ?",
    "Combien de fois mangez-vous des œufs par semaine ?",
    "Combien de fois par semaine consommez-vous des légumineuses (lentilles, pois, haricots blancs,...) ?",
    "Combien de fois par semaine consommez-vous des pâtisseries (gâteaux, sucreries, barres chocolatées,...) ?",
    "Combien de fois par semaine consommez-vous des viennoiseries (croissants, pains au chocolat,...) ?",
    "Combien de fois mangez-vous des plats cuisinés par semaine ?",
    "Combien de fois êtes-vous exposé(e) à plus de 30 min en continu à l'extérieur ?"
  ],
  'Troubles': [
    "Je me sens fatigué(e)",
    "Problèmes de sommeil",
    "Je me sens anxieux(se)",
    "Je me sens déprimé(e)",
    "J'ai des brûlures d'estomac",
    "J'ai des reflux acides",
    "J'ai des nausées",
    "J'ai des diarrhées ou constipations",
    "Avez vous des ballonements après les repas ?",
    "Avez vous régulièrement des pets très odorants?",
    "Avez vous des maux de ventre?"
  ]
};

// Formulaire dynamique
const form = document.getElementById('dietForm');
const container = document.getElementById('categories');

Object.keys(categoriesData).forEach(cat => {
  const card = document.createElement('div');
  card.className = 'card';
  let html = `<fieldset><legend>${cat}</legend>`;
  categoriesData[cat].forEach((q, index) => {
    const id = `${cat}-${index}`;
    html += `<label>${q}
      <select name="${id}" data-category="${cat}" data-question="${q}">
        <option value="">-- Choisissez --</option>
        <option value="0">0</option>
        <option value="1">1</option>
        <option value="2">2</option>
        <option value="3">3</option>
        <option value="4">4</option>
        <option value="5">5</option>
      </select>
    </label>`;
  });
  html += `</fieldset>`;
  card.innerHTML = html;
  container.appendChild(card);
});

// Progression et scores
form.addEventListener('change', updateForm);

function updateForm() {
  const selects = form.querySelectorAll('select');
  let total = 0;
  let answered = 0;
  selects.forEach(sel => {
    if (sel.value !== "") {
      total += parseInt(sel.value);
      answered++;
    }
  });
  document.getElementById('scoreTotal').textContent = total;
  const percentage = Math.round((answered / selects.length) * 100);
  document.getElementById('progressBar').style.width = percentage + '%';
  document.getElementById('progressText').textContent = percentage + '% complété';
  updateCarences();
}

// Règles de carence exactes
const reglesCarences = [
  { selectName: "Alimentation-11", valeursDeclenchantes: [0], message: "Carence en EPA/DHA" },
  { selectName: "Alimentation-17", valeursDeclenchantes: [0, 1, 2], message: "Carence en Vit D" },
  { selectName: "Alimentation-6", valeursDeclenchantes: [0, 1], message: "Carence en Manganèse et Vitamines" },
  { selectName: "Alimentation-8", valeursDeclenchantes: [0, 1], message: "Carence possible en Magnésium" },
  { selectName: "Alimentation-7", valeursDeclenchantes: [0, 1], message: "Carence possible en Anti-oxydant" }
];

// Détection de carences
function updateCarences() {
  const carenceDiv = document.getElementById('carencesDetectees');
  const messages = [];

  for (const regle of reglesCarences) {
    const select = document.querySelector(`select[name="${regle.selectName}"]`);
    if (select && select.value !== "") {
      const valeur = parseInt(select.value);
      if (!isNaN(valeur) && regle.valeursDeclenchantes.includes(valeur)) {
        messages.push("⚠️ " + regle.message);
      }
    }
  }

  if (messages.length > 0) {
    carenceDiv.innerHTML = `
      <h3 style="color: #b71c1c;">Carence(s) détectée(s) :</h3>
      <ul style="color: #b71c1c; font-weight: bold;">
        ${messages.map(msg => `<li>${msg}</li>`).join('')}
      </ul>
    `;
    carenceDiv.style.borderLeft = "6px solid #e53935";
    carenceDiv.style.backgroundColor = "#ffebee";
  } else {
    carenceDiv.innerHTML = `<h3 style="color: #2e7d32;">✅ Aucune carence détectée</h3>`;
    carenceDiv.style.borderLeft = "6px solid #43a047";
    carenceDiv.style.backgroundColor = "#e8f5e9";
  }
}

// Résumé avant envoi
form.addEventListener('submit', function(event) {
  const selects = form.querySelectorAll('select');
  const unfilled = Array.from(selects).some(sel => sel.value === "");
  if (unfilled) {
    event.preventDefault();
    alert("Veuillez répondre à toutes les questions avant de soumettre le formulaire.");
    return;
  }

  let summary = '';
  Object.keys(categoriesData).forEach(cat => {
    const selects = form.querySelectorAll(`select[data-category="${cat}"]`);
    if (selects.length > 0) {
      summary += `\nCatégorie ${cat} :\n`;
      selects.forEach(sel => {
        const label = sel.getAttribute('data-question');
        summary += `- ${label} (Score: ${sel.value})\n`;
      });
    }
  });
  const carences = document.getElementById('carencesDetectees').innerText;
  const scoreTotal = document.getElementById('scoreTotal').textContent;
  summary += `\nScore total : ${scoreTotal}\n\n${carences}`;
  document.getElementById('summaryField').value = summary;
  alert('Merci pour votre envoi !');
});
</script>
